<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Monitoring System - Dynamic Control</title>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Traffic Monitoring System</h1>
            <div class="livestream-controls">
                <select id="piAddressSelect">
                    <option value="">Auto-detect Pi</option>
                </select>
                <button id="startBtn" onclick="startLivestream()">Start Livestream</button>
                <button id="stopBtn" onclick="stopLivestream()" disabled>Stop Livestream</button>
                <button id="testBtn" onclick="testConnection()">Test Connection</button>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>Stream Mode:</label>
                <button id="rawBtn" onclick="switchStream('raw')">Raw + Overlay</button>
                <button id="processedBtn" onclick="switchStream('processed')">AI Processed</button>
            </div>
            
            <div class="control-group">
                <label>Detection:</label>
                <span id="detectionCount">0</span> objects
            </div>
        </div>
        
        <div class="video-container" style="position: relative; display: inline-block;">
            <img id="videoStream" 
                 src="" 
                 style="width: 640px; height: 360px; border: 1px solid #ccc; display: block;"
                 onerror="handleStreamError()">
            <canvas id="overlay" 
                    width="640" 
                    height="360"
                    style="position: absolute; top: 0; left: 0; pointer-events: none;">
            </canvas>
        </div>
        
        <div class="status" id="status">
            Checking status...
        </div>
        
        <div class="pi-address-info" id="piAddressInfo">
            <strong>Available Pi Addresses:</strong>
            <div id="addressList">Loading...</div>
            <div class="connection-test">
                <span>Connection Test:</span>
                <div id="connectionResult">Not tested</div>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-title">Total Vehicles</div>
                <div class="stat-value" id="totalCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Cars</div>
                <div class="stat-value" id="carCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Trucks</div>
                <div class="stat-value" id="truckCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Motorcycles</div>
                <div class="stat-value" id="motorbikeCount">0</div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById("overlay");
        const ctx = canvas.getContext("2d");
        const img = document.getElementById("videoStream");
        const status = document.getElementById("status");
        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");
        const testBtn = document.getElementById("testBtn");
        const piAddressSelect = document.getElementById("piAddressSelect");
        const addressList = document.getElementById("addressList");
        const connectionResult = document.getElementById("connectionResult");
        
        // Scale factors for coordinate conversion (backend uses 480x270, frontend displays 640x360)
        const scaleX = 640 / 480;  // display width / detection width
        const scaleY = 360 / 270;  // display height / detection height
        
        let currentMode = 'raw';
        let overlayEnabled = true;
        let livestreamRunning = false;
        let availablePiAddresses = [];
        let detectionInterval = null;
        let statsInterval = null;
        let statusInterval = null;
        
        console.log("Starting traffic monitoring system with dynamic control...");
        
        // === LIVESTREAM CONTROL FUNCTIONS ===
        
        async function startLivestream() {
            try {
                startBtn.disabled = true;
                startBtn.textContent = 'Starting...';
                
                const selectedSource = piAddressSelect.value || null;
                
                const response = await fetch("http://localhost:8000/api/dashboard/start-livestream", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        camera_source: selectedSource
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    livestreamRunning = true;
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    updateStatus("connected", `Livestream Active: ${data.camera_source}`);
                    
                    // Start the video stream
                    switchStream(currentMode);
                    
                    // Start polling for data
                    startPolling();
                    
                    console.log("Livestream started successfully");
                } else {
                    updateStatus("error", data.message);
                    console.error("Failed to start livestream:", data.message);
                }
                
            } catch (error) {
                console.error("Error starting livestream:", error);
                updateStatus("error", "Failed to start livestream");
            } finally {
                startBtn.disabled = false;
                startBtn.textContent = 'Start Livestream';
            }
        }
        
        async function stopLivestream() {
            try {
                stopBtn.disabled = true;
                stopBtn.textContent = 'Stopping...';
                
                const response = await fetch("http://localhost:8000/api/dashboard/stop-livestream", {
                    method: "POST"
                });
                
                const data = await response.json();
                
                if (data.success) {
                    livestreamRunning = false;
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    updateStatus("stopped", "Livestream Stopped");
                    
                    // Stop the video stream
                    img.src = "";
                    
                    // Stop polling
                    stopPolling();
                    
                    // Clear canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    console.log("Livestream stopped successfully");
                } else {
                    updateStatus("error", data.message);
                    console.error("Failed to stop livestream:", data.message);
                }
                
            } catch (error) {
                console.error("Error stopping livestream:", error);
                updateStatus("error", "Failed to stop livestream");
            } finally {
                stopBtn.disabled = false;
                stopBtn.textContent = 'Stop Livestream';
            }
        }
        
        async function testConnection() {
            try {
                testBtn.disabled = true;
                testBtn.textContent = 'Testing...';
                connectionResult.textContent = "Testing...";
                connectionResult.style.color = "orange";
                
                const selectedIndex = piAddressSelect.selectedIndex - 1; // -1 because first option is "Auto-detect"
                
                if (selectedIndex < 0) {
                    // Test all addresses
                    connectionResult.textContent = "Testing all addresses...";
                    let anyConnected = false;
                    
                    for (let i = 0; i < availablePiAddresses.length; i++) {
                        const response = await fetch(`http://localhost:8000/api/dashboard/test-pi-connection?address_index=${i}`);
                        const data = await response.json();
                        
                        if (data.connected) {
                            anyConnected = true;
                            connectionResult.textContent = `✓ ${data.address} - Connected`;
                            connectionResult.style.color = "green";
                            break;
                        }
                    }
                    
                    if (!anyConnected) {
                        connectionResult.textContent = "✗ No Pi cameras found";
                        connectionResult.style.color = "red";
                    }
                } else {
                    // Test specific address
                    const response = await fetch(`http://localhost:8000/api/dashboard/test-pi-connection?address_index=${selectedIndex}`);
                    const data = await response.json();
                    
                    if (data.connected) {
                        connectionResult.textContent = `✓ ${data.address} - Connected`;
                        connectionResult.style.color = "green";
                    } else {
                        connectionResult.textContent = `✗ ${data.address} - Failed`;
                        connectionResult.style.color = "red";
                    }
                }
                
            } catch (error) {
                console.error("Error testing connection:", error);
                connectionResult.textContent = "✗ Test failed";
                connectionResult.style.color = "red";
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'Test Connection';
            }
        }
        
        async function loadPiAddresses() {
            try {
                const response = await fetch("http://localhost:8000/api/dashboard/livestream-status");
                const data = await response.json();
                
                availablePiAddresses = data.available_sources || [];
                
                // Update select options
                piAddressSelect.innerHTML = '<option value="">Auto-detect Pi</option>';
                availablePiAddresses.forEach((address, index) => {
                    const option = document.createElement("option");
                    option.value = address;
                    option.textContent = `Pi ${index + 1}: ${address}`;
                    piAddressSelect.appendChild(option);
                });
                
                // Update address info
                addressList.innerHTML = availablePiAddresses.length > 0 
                    ? availablePiAddresses.map((addr, i) => `Pi ${i + 1}: ${addr}`).join('<br>')
                    : 'No Pi addresses configured';
                
            } catch (error) {
                console.error("Error loading Pi addresses:", error);
                addressList.innerHTML = 'Error loading addresses';
            }
        }
        
        // === STREAM CONTROL FUNCTIONS ===
        
        function switchStream(mode) {
            currentMode = mode;
            
            // Update button styles
            document.getElementById('rawBtn').style.backgroundColor = mode === 'raw' ? '#007bff' : '';
            document.getElementById('rawBtn').style.color = mode === 'raw' ? 'white' : '';
            document.getElementById('processedBtn').style.backgroundColor = mode === 'processed' ? '#007bff' : '';
            document.getElementById('processedBtn').style.color = mode === 'processed' ? 'white' : '';
            
            // Update stream source only if livestream is running
            if (livestreamRunning) {
                if (mode === 'raw') {
                    img.src = "http://localhost:8000/api/dashboard/video-feed/raw";
                    overlayEnabled = true;
                    canvas.style.display = 'block';
                } else {
                    img.src = "http://localhost:8000/api/dashboard/video-feed/processed";
                    overlayEnabled = false;
                    canvas.style.display = 'none';
                }
                console.log(`Switched to ${mode} mode`);
            }
        }
        
        // === STATUS AND DETECTION FUNCTIONS ===
        
        async function fetchDetections() {
            if (!livestreamRunning || !overlayEnabled) return;
            
            try {
                const res = await fetch("http://localhost:8000/api/dashboard/detection-data");
                const data = await res.json();
                
                // Update detection count
                document.getElementById("detectionCount").textContent = data.objects ? data.objects.length : 0;
                
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Setup drawing style
                ctx.strokeStyle = "lime";
                ctx.lineWidth = 2;
                ctx.font = "14px Arial";
                ctx.fillStyle = "lime";
                
                // Draw detections
                if (data.objects && Array.isArray(data.objects)) {
                    data.objects.forEach(obj => {
                        if (obj.bbox && obj.bbox.length === 4) {
                            const [x1, y1, x2, y2] = obj.bbox;
                            
                            // Scale coordinates from backend (480x270) to frontend (640x360)
                            const scaledX = x1 * scaleX;
                            const scaledY = y1 * scaleY;
                            const scaledW = (x2 - x1) * scaleX;
                            const scaledH = (y2 - y1) * scaleY;
                            
                            // Draw bounding box
                            ctx.strokeRect(scaledX, scaledY, scaledW, scaledH);
                            
                            // Draw label with background
                            const label = `${obj.label} ${Math.round(obj.confidence * 100)}%`;
                            const textWidth = ctx.measureText(label).width;
                            
                            // Draw label background
                            ctx.fillStyle = "rgba(0, 255, 0, 0.8)";
                            ctx.fillRect(scaledX, scaledY - 20, textWidth + 10, 18);
                            
                            // Draw label text
                            ctx.fillStyle = "black";
                            ctx.fillText(label, scaledX + 5, scaledY - 5);
                        }
                    });
                }
                
            } catch (error) {
                if (livestreamRunning) {
                    console.error("Error fetching detections:", error);
                }
            }
        }
        
        async function fetchStats() {
            if (!livestreamRunning) return;
            
            try {
                const res = await fetch("http://localhost:8000/api/dashboard/stats");
                const data = await res.json();
                
                // Update total count
                document.getElementById("totalCount").textContent = data.total_count || 0;
                
                // Update individual counts
                const counts = data.vehicle_counts || {};
                document.getElementById("carCount").textContent = counts.car || 0;
                document.getElementById("truckCount").textContent = counts.truck || 0;
                document.getElementById("motorbikeCount").textContent = counts.motorbike || 0;
                
            } catch (error) {
                console.error("Error fetching stats:", error);
            }
        }
        
        async function checkLivestreamStatus() {
            try {
                const response = await fetch("http://localhost:8000/api/dashboard/livestream-status");
                const data = await response.json();
                
                const wasRunning = livestreamRunning;
                livestreamRunning = data.running;
                
                // Update button states
                startBtn.disabled = livestreamRunning;
                stopBtn.disabled = !livestreamRunning;
                
                // Update status
                if (data.running) {
                    updateStatus("connected", `Livestream Active: ${data.camera_source || 'Unknown source'}`);
                    if (!wasRunning) {
                        // Livestream just started, initialize video stream
                        switchStream(currentMode);
                        startPolling();
                    }
                } else {
                    updateStatus("stopped", "Livestream Stopped");
                    if (wasRunning) {
                        // Livestream just stopped
                        img.src = "";
                        stopPolling();
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                    }
                }
                
                // If status changed, log it
                if (wasRunning !== livestreamRunning) {
                    console.log(`Livestream status changed: ${livestreamRunning ? 'Started' : 'Stopped'}`);
                }
                
            } catch (error) {
                console.error("Error checking livestream status:", error);
                updateStatus("error", "Status Check Failed");
            }
        }
        
        function updateStatus(className, message) {
            status.textContent = message;
            status.style.color = className === 'connected' ? 'green' : 
                                 className === 'error' ? 'red' : 
                                 className === 'stopped' ? 'orange' : 'black';
        }
        
        function handleStreamError() {
            if (livestreamRunning) {
                console.error("Video stream error");
                updateStatus("error", "Stream Error - Check Pi connection");
            }
        }
        
        // === POLLING FUNCTIONS ===
        
        function startPolling() {
            if (!detectionInterval) {
                detectionInterval = setInterval(fetchDetections, 200);
            }
            if (!statsInterval) {
                statsInterval = setInterval(fetchStats, 2000);
            }
        }
        
        function stopPolling() {
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
            }
        }
        
        // === INITIALIZATION ===
        
        // Handle image load events
        img.onload = () => {
            console.log("Video stream loaded successfully");
        };
        
        img.onerror = handleStreamError;
        
        // Initialize everything
        async function initialize() {
            await loadPiAddresses();
            await checkLivestreamStatus();
            
            // Set initial mode
            switchStream('raw');
        }
        
        // Start status checking interval
        statusInterval = setInterval(checkLivestreamStatus, 3000);
        
        // Initialize on load
        initialize();
    </script>
</body>
</html>